#!/usr/bin/env ansible-playbook
---

- name: "Update ssh keys"
  hosts:
    - all
  vars:
    add_ssh_keys: []
    remove_ssh_keys: []
    groups_to_add: "adm,dialout,cdrom,floppy,sudo,audio,dip,video,plugdev,lxd,netdev,docker"

  tasks:

    - name: add users
      block:

        - name: user name
          set_fact:
            user_name: "{{ item.split()[-1] }}"
          register: user_name_result
          with_items: "{{ add_ssh_keys }}"

        - name: make user namelist
          set_fact:
            user_names: "{{ user_name_result.results | map(attribute='ansible_facts.user_name') | list | reject('equalto', 'Generated-by-Nova') | list }}"

        - name: list of user to create
          debug: var=user_names

        - name: Create user account
          user:
            name: "{{ item }}"
            shell: /bin/bash
            groups: "{{ groups_to_add }}"
            append: yes
          with_items: "{{ user_names }}"

        - name: Create ~/.ssh/
          file:
            path: "/home/{{ item }}/.ssh"
            state: directory
            owner: "{{ item }}"
            group: "{{ item }}"
            mode: "0700"
          with_items: "{{ user_names }}"

        - name: Add to authorized_keys
          lineinfile:
            line: "{{ item }}"
            path: "/home/{{ item.split()[-1] }}/.ssh/authorized_keys"
            regex: "{{  item.split()[1] | regex_escape() }}" # use the hash to match
            create: yes
            owner: "{{ item.split()[-1] }}"
            group: "{{ item.split()[-1] }}"
            mode: 0600
          loop: "{{ add_ssh_keys }}"
          when: "not item.split()[-1] == 'Generated-by-Nova'"

        - name: Add to sudoers
          lineinfile:
            line: "{{ item }} ALL=(ALL) NOPASSWD:ALL"
            path: "/etc/sudoers.d/99-systems-team"
            regex: "{{ item }}"
            create: yes
            owner: "root"
            group: "root"
            mode: 0440
          with_items: "{{ user_names }}"

      become: yes
      tags:
        - addusers

    - name: remove users
      block:

        - name: user name
          set_fact:
            user_name: "{{ item.split()[-1] }}"
          register: user_name_result
          with_items: "{{ remove_ssh_keys }}"

        - name: make user namelist
          set_fact:
            user_names: "{{ user_name_result.results | map(attribute='ansible_facts.user_name') | list | reject('equalto', 'Generated-by-Nova') | list }}"

        - name: list of user to create
          debug: var=user_names

        - name: Remove user account
          user:
            name: "{{ item }}"
            state: absent
          with_items: "{{ user_names }}"

        - name: Remove from sudoers
          lineinfile:
            path: "/etc/sudoers.d/99-systems-team"
            regex: "{{ item }}"
            state: absent
          with_items: "{{ user_names }}"

      become: yes
      tags:
        - removeusers

    - name: Add ssh key
      lineinfile:
        line: "{{ item }}"
        dest: ~/.ssh/authorized_keys
        regex: "{{ item.split()[1] | regex_escape() }}" # use the hash to match
        create: no
        mode: 0600
      with_items: "{{ add_ssh_keys }}"
      tags:
        - add

    - name: remove ssh key
      lineinfile:
        line: "{{ item }}"
        dest: ~/.ssh/authorized_keys
        state: absent
      with_items: "{{ remove_ssh_keys }}"
      tags:
        - remove
