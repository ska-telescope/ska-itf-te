.deploy-octopus:
  tags:
    - ska-k8srunner-za-itf
  stage: deploy-supplementary-services
  image: $DEPLOY_IMAGE
  variables:
    KUBE_APP: octopus
    K8S_CHART: ska-mid
    OCTOPUS_ENABLERS: "-f .gitlab/ci/za-itf/octopus/octopus-enablers.yaml"
    KUBE_NAMESPACE: octopus
    HELM_RELEASE: octopus
  when: manual
  script:
    - make vars
    - bash .make/resources/gitlab_section.sh install "Install chart" make k8s-install-chart
    - bash .make/resources/gitlab_section.sh wait "Wait for installation" make k8s-wait

.redeploy-octopus:
  extends:
    - .deploy-octopus
  before_script:
    - !reference [.uninstall-chart, script]
    - kubectl wait --for=delete namespace/$KUBE_NAMESPACE --timeout=60s

.destroy-octopus:
  extends:
    - .deploy-octopus
  script:
    - !reference [.uninstall-chart, script]
    - kubectl wait --for=delete namespace/$KUBE_NAMESPACE --timeout=60s

deploy-octopus:
  extends:
    - .deploy-octopus

redeploy-octopus:
  extends:
    - .redeploy-octopus

destroy-octopus:
  extends:
    - .destroy-octopus
