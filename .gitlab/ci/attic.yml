# ############################################
# # System Under Test Deployment and Test jobs
# ############################################
.sut_base:
  tags:
    - ska-k8srunner-za-itf
  variables:
    CONFIG: mid
    CLUSTER_DOMAIN_POSTFIX: miditf.internal.skao.int
    DISH_IDS: "SKA001 SKA036 SKA063 SKA100"
    K8S_CHART: system-under-test
    KUBE_APP: ska-mid-sut
    INGRESS_HOST: "k8s.miditf.internal.skao.int"
    CLUSTER_DOMAIN: "miditf.internal.skao.int"
    K8S_EXTRA_PARAMS: "--set global.ska-tango-archiver.enabled=false  --set ska-tango-archiver.enabled=false"
    TANGO_DATABASE_DS: tango-databaseds
    KUBE_NAMESPACE: ci-ska-mid-itf-$CI_COMMIT_REF_NAME
    
.sut_on_demand:
  stage: on_demand_itf_sut
  extends:
    - .sut_base
    - .on_demand_rules
  variables:
    HELM_RELEASE: sut ## in term of variables this is the only difference with sut_base
    KUBE_NAMESPACE: "ci-ska-mid-itf-$CI_COMMIT_REF_NAME"
    KUBE_NAMESPACE_SDP: "$KUBE_NAMESPACE-sdp"
    SERVICE_ACCOUNT: "ci-svc-ska-miditf-$CI_COMMIT_REF_NAME"

##################################################################################
### The deployments of additional dish structure simulators are disabled.      ###
### We still need to determine how exactly we will deploy these with Dish LMC. ###
##################################################################################

.deploy-aa05-ds-sim:
  stage: on_demand_itf_sut
  extends:
    - .sut_base
  script:
    - echo "Deploying multiple dish structure simulators in downstream dish-aiv stage - first deploy ska001 manually"
    - echo "Deploying 'SKA001', 'SKA036', 'SKA063', 'SKA100'"
  environment:
    name: mid-itf/integration/dish-structure-simulator-aa05
    on_stop: remove-aa05-ds-sim
  when: manual

.remove-aa05-ds-sim:
  stage: on_demand_itf_sut
  extends:
    - .sut_base
  script:
    - echo "Uninstalling all dish structure simulators in downstream dish-aiv stage"
    - echo "Uninstalling 'SKA001', 'SKA036', 'SKA063', 'SKA100'"
  environment:
    name: mid-itf/integration/dish-structure-simulator-aa05
    action: stop
  when: manual

.deploy-additional-dish-structure-simulator:
  extends:
    - .deploy-dish-structure-simulator
    - .integration_rules
  when: on_success
  needs:
    - deploy-aa05-ds-sim

.deploy-ds-sim-ska036:
  extends: .deploy-additional-dish-structure-simulator
  variables:
    DISH_INDEX: "036"
  environment:
    on_stop: remove-ds-sim-ska001

.remove-ds-sim-ska036:
  extends: .remove-dish-structure-simulator
  variables:
    DISH_INDEX: "036"

.deploy-ds-sim-ska063:
  extends: .deploy-additional-dish-structure-simulator
  variables:
    DISH_INDEX: "063"
  environment:
    on_stop: remove-ds-sim-ska001

.remove-ds-sim-ska063:
  extends: .remove-dish-structure-simulator
  variables:
    DISH_INDEX: "063"

.deploy-ds-sim-ska100:
  extends: .deploy-additional-dish-structure-simulator
  variables:
    DISH_INDEX: "100"
  environment:
    on_stop: remove-ds-sim-ska100

.remove-ds-sim-ska100:
  extends: .remove-dish-structure-simulator
  variables:
    DISH_INDEX: "100"
