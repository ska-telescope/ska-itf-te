---

- name: Setup variables
  block:
    - name: Set user groups
      ansible.builtin.set_fact:
        user_setup_user_groups: "{{ user_config['groups'] }}"
    - name: Set users
      ansible.builtin.set_fact:
        user_setup_users: "{{ user_config['users'] }}"
    - name: Set add_to_sudoers
      ansible.builtin.set_fact:
        user_setup_add_to_sudoers: "yes"
      when: "'sudo' in user_setup_user_groups"

  # Creates new users and adds them to sudoers if so configured.
- name: Create users
  when: createusers
  become: true
  block:
    - name: Create user group
      ansible.builtin.group:
        name: "{{ item }}"
        state: present
      loop: "{{ user_setup_users }}"

    - name: Create user accounts
      ansible.builtin.user:
        name: "{{ item }}"
        shell: /bin/bash
        group: "{{ item }}"
        groups: "{{ [item] + user_setup_user_groups }}"
        append: true
      loop: "{{ user_setup_users }}"

    - name: Add to sudoers
      when: user_setup_add_to_sudoers
      ansible.builtin.lineinfile:
        line: "{{ item }} ALL=(ALL) NOPASSWD:ALL"
        path: "/etc/sudoers.d/99-systems-team"
        regex: "{{ item }}"
        create: true
        owner: "root"
        group: "root"
        mode: "0440"
      loop: "{{ user_setup_users }}"

- name: Remove users
  become: true
  when: removeusers
  block:
    - name: Remove user account
      ansible.builtin.user:
        name: "{{ item }}"
        state: absent
        remove: true
      loop: "{{ user_setup_users }}"

    - name: Remove from sudoers
      ansible.builtin.lineinfile:
        path: "/etc/sudoers.d/99-systems-team"
        regex: "{{ item }}"
        state: absent
      loop: "{{ user_setup_users }}"
