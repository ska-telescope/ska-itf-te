---
# Make all the realms visible to Gaia

- name: Add SSH Config
  ansible.builtin.template:
    src: ssh_config.j2
    dest: /home/{{ user_name }}/.ssh/config
    mode: 0600

- name: Add Bash Aliases
  ansible.builtin.template:
    src: bash_aliases.j2
    dest: /home/{{ user_name }}/.bash_aliases
    mode: 0755

- name: Ensure shared directory exists
  ansible.builtin.file:
    path: "{{ shared_dir }}"
    state: directory
    owner: "root"
    group: "root"
    mode: 0755
  become: true

- name: Ensure shared common directory exists
  ansible.builtin.file:
    path: "{{ shared_common_dir }}"
    state: directory
    owner: "root"
    group: "root"
    mode: 0777
  become: true

- name: Ensure shared team directory exists
  ansible.builtin.file:
    path: "{{ shared_team_dir }}"
    state: directory
    owner: "root"
    group: "{{ team_group }}"
    mode: 0770
  become: true

- name: Ensure team config directory exists
  ansible.builtin.file:
    path: "{{ shared_team_config_dir }}"
    state: directory
    owner: "root"
    group: "{{ team_group }}"
    mode: 0770
  become: true

# Personalise login
- name: Install ASCII art generators
  apt:
    pkg: [figlet, toilet]
  become: true

- name: Upload welcome message script
  template:
    src: welcome.sh.j2
    dest: "{{ shared_common_dir }}/welcome.sh"
    owner: "root"
    group: "root"
    mode: 0755
  become: true

- name: Install generic welcome message
  ansible.builtin.blockinfile:
    path: /etc/profile
    block: |
      # Personalised welcome messages. Change at will :)
      . {{ shared_common_dir }}/welcome.sh
    marker: "# {mark} ANSIBLE MANAGED BLOCK"
  become: true

- name: Setup Kubeconfig
  when: setup_kubeconfig
  block:
    - name: Upload kubeconfig script
      template:
        src: kubeconfig_setup.sh.j2
        dest: "{{ shared_common_dir }}/kubeconfig_setup.sh"
        owner: "root"
        group: "root"
        mode: 0755
      become: true

    - name: Install kubeconfig script
      ansible.builtin.blockinfile:
        path: /etc/profile
        block: |
          # Set kubeconfig to default shared config.
          . {{ shared_common_dir }}/kubeconfig_setup.sh
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
      become: true
